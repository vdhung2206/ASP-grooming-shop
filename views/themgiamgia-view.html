<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://use.fontawesome.com/releases/v5.0.4/css/all.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <title>Document</title>
</head>

<body>

    <!-- #include file="../share/header.html" -->
    <div class="container col-6">
        <form id="form-them-gg">
            <div class="form-group">
                <input type="hidden" name="loai" value="themsanpham">
            </div>
            <div class="form-group">
                <label for="magg">Mã giảm giá</label>
                <input type="text" name="magg" class="form-control" id="magg">
            </div>
            <div class="form-group">
                <label for="tengg">Tên giảm giá</label>
                <input type="text" name="tengg" class="form-control" id="tengg">
            </div>
            <div class="form-group">
                <label for="loaigg">Loại giảm giá</label>
                <select name="loaigg" id="loaigg" class="form-select">
                    <option value="0">Giảm giá khách hàng</option>
                    <option value="1">Giảm giá sản phẩm</option>
                </select>
            </div>
            <div class="form-group">
                <label for="tichdiem">Tích điểm lớn hơn:</label>
                <input type="text" name="tichdiem" class="form-control" id="tichdiem">
            </div>
            <div class="form-group">
                <label for="sp">Sản phẩm</label>
                <input placeholder="Nhập tên sản phẩm" type="text" class="form-control" list="listsp" id="searchsp">
                <datalist id="listsp">
                </datalist>
                <button id="addlist" class="btn btn-primary">Thêm vào danh sách</button>
            </div>
            <div class="form-group">
                <label for="hang">Hãng</label>
                <select name="hangsp" id="hangsp" class="form-select">
                </select>
            </div>
            <div class="form-group">
                <label for="danhmuc">Danh mục</label>
                <select name="danhmuc" id="danhmuc" class="form-select">
                </select>
            </div>
            <div class="form-group">
                <label for="loaisp">Loại</label>
                <select name="loaisp" id="loaisp" class="form-select">
                </select>
            </div>
            <div class="form-group">
                <label for="sp">Các sản phẩm đã chọn</label>
                <textarea class="form-control" id="listsearchsp"> </textarea>
            </div>
            <div class="form-group">
                <label for="ngaybatdau">Ngày bắt đầu:</label>
                <input type="date" name="ngaybatdau" class="form-control" id="ngaybatdau">
            </div>
            <div class="form-group">
                <label for="ngayketthuc">Ngày kết thúc:</label>
                <input type="date" name="ngayketthuc" class="form-control" id="ngayketthuc">
            </div>
            <div class="row px-2 mt-4">
                <button type="submit" class="btn btn-primary">Tạo mới</button>
            </div>
        </form>
    </div>
</body>

</html>
<script src="share.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous">
    </script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script>
    var madm
    var listsp = []
    $("#addlist").click(function () {
        if (!listsp.includes($("#masp1").val())) {
            listsp.push($("#masp1").val())
            $("#listsearchsp").append($("#searchsp").val() + "&#13;&#10; ")
        }
        else {
            addAlertDanger("Bạn đã chọn sản phẩm này rồi!")
        }
    })
    $("#searchsp").keyup(function () {
        $.ajax({
            method: "get",
            url: "../controllers/sanpham-controller.asp",
            data: {
                tensp: $(this).val(),
                loai: "timkiemsanpham",
            },
            success: function (response) {
                const obj = JSON.parse(response);
                var str = ""
                obj.data.danhsachsanpham.forEach(element => {
                    str += "<option value=\"" + element.tensp + "\">";
                    str += element.tensp
                    str += "</option>";
                    str += "<input id = \"masp1\"type=\"hidden\" value=\"" + element.masp + "\">"
                })
                $("#listsp").html(str)
            }
        })
    })
    $("#form-them-gg").submit(function (e) {
        e.preventDefault()
        var magg = $("#magg").val()
        var tengg = $("#tengg").val()
        var loaigg = $("#loaigg").val()
        var tichdiem = $("#tichdiem").val()
        var hangsp = $("#hangsp").val()
        var loaisp = $("#loaisp").val()
        var danhmuc = $("#danhmuc").val()
        var ngaybatdau = $("#ngaybatdau").val()
        var ngayketthuc = $("#ngayketthuc").val()
        console.log(loaigg)
        if (magg != "") {
            if (tengg != "") {
                if ((loaigg == 0 && tichdiem != "") || loaigg == 1) {
                    if ((loaigg == 0 && tichdiem.match(/^\d+$/)) || loaigg == 1) {

                    }
                    else {
                        addAlertDanger("Tích điểm phải là số lớn hơn hoặc bằng 0!")
                    }
                }
                else {
                    addAlertDanger("Tích điểm không được để trống!")
                }
            }
            else {
                addAlertDanger("Tên chương trình giảm giá không được để trống!")
            }
        }
        else {
            addAlertDanger("Mã giảm giá không được để trống!")
        }
    })
    $("#danhmuc").change(function () {
        madm = $(this).val()
        if (madm != "") {
            $.ajax({
                method: "get",
                url: "../controllers/danhmuc-controller.asp",
                data: {
                    madm: madm,
                    loai: "getList",
                },
                success: function (response) {
                    const obj = JSON.parse(response);
                    var str = "<option value=\"0\">Không</option>"

                    if (madm != "") {
                        obj.data.listloaisp.forEach(element => {
                            str += "<option value=\"" + element.maloaisp + "\">";
                            str += element.tenloaisp
                            str += "</option>";
                        })
                    }
                    $("#loaisp").html(str)
                }
            })
        }
    })
    $("#hangsp").change(function () {
        if ($(this).val() != 0) {
            $.ajax({
                method: "get",
                url: "../controllers/sanpham-controller.asp",
                data: {
                    hangsp: $(this).val(),
                    loai: "timkiemsanphamtheohang",
                },
                success: function (response) {
                    const obj = JSON.parse(response);
                    console.log(obj)
                    obj.data.danhsachsanpham.forEach(element => {
                        if(!listsp.includes(element.masp)){
                            $("#listsearchsp").append(element.tensp + "&#13;&#10; ")
                            listsp.push(element.masp)
                        }
                        console.log(listsp)
                    })
                }
            })
        }
    })
    $("#loaigg").change(function () {
        if ($(this).val() == 0) {
            $("#hangsp").prop("disabled", true)
            $("#danhmuc").prop("disabled", true)
            $("#loaisp").prop("disabled", true)
            $("#tichdiem").prop("disabled", false)
            $("#addlist").prop("disabled", true)
            $("#searchsp").prop("disabled", true)
        }
        else {
            $("#hangsp").prop("disabled", false)
            $("#danhmuc").prop("disabled", false)
            $("#loaisp").prop("disabled", false)
            $("#tichdiem").prop("disabled", true)
            $("#addlist").prop("disabled", false)
            $("#searchsp").prop("disabled", false)
        }
    })
    $(document).ready(function () {
        $("#hangsp").prop("disabled", true)
        $("#danhmuc").prop("disabled", true)
        $("#loaisp").prop("disabled", true)
        $("#tichdiem").prop("disabled", false)
        $("#addlist").prop("disabled", true)
        $("#searchsp").prop("disabled", true)
        $.ajax({
            method: "get",
            url: "../controllers/danhmuc-controller.asp",
            data: {
                loai: "getListDanhMuc",
            },
            success: function (response) {
                var str = "<option value=\"0\">Không</option>"

                const obj = JSON.parse(response);
                madm = obj.data.listdanhmuc[0].madm
                obj.data.listdanhmuc.forEach(element => {
                    str += "<option value=\"" + element.madm + "\">" + element.tendm;
                    str += "</option>";
                });
                $("#danhmuc").html(str)
                $.ajax({
                    method: "get",
                    url: "../controllers/danhmuc-controller.asp",
                    data: {
                        madm: madm,
                        loai: "getList",
                    },
                    success: function (response) {
                        const obj = JSON.parse(response);
                        var str = "<option value=\"0\">Không</option>"
                        if (madm != "") {
                            obj.data.listloaisp.forEach(element => {
                                str += "<option value=\"" + element.maloaisp + "\">";
                                str += element.tenloaisp
                                str += "</option>";
                            })
                        }
                        $("#loaisp").html(str)
                    }
                })
            }
        })
        $.ajax({
            method: "get",
            url: "../controllers/sanpham-controller.asp",
            data: {
                loai: "laydanhsachhang",
            },
            success: function (response) {
                const obj = JSON.parse(response);
                console.log(obj)
                var str = "<option value=\"0\">Không</option>"
                if (madm != "") {
                    obj.data.danhsachhang.forEach(element => {
                        str += "<option value=\"" + element + "\">";
                        str += element;
                        str += "</option>";
                    })
                }
                $("#hangsp").html(str)
            }
        })
    })
    function addAlertDanger(msg) {
        $("#msg").addClass("alert alert-danger mt-2");
        $("#msg").html(msg);
        $(".alert").fadeTo(500, 1).slideDown(500, function () {
        });
        window.setTimeout(function () {
            $(".alert").fadeTo(500, 0).slideUp(500, function () {
            });
        }, 2000);
    }
</script>